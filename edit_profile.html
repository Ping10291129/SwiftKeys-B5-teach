<!doctype html>
<html lang="zh">

<head>
   <!-- Required meta tags -->
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <title>SwiftKeys后台管理</title>
   <link rel="stylesheet" href="css/edit_profile.css">
   <link rel="stylesheet" href="css/font.css">
   <link rel="stylesheet" href="css/style.css">
</head>

<body data-page="edit_profile">
   <div id="loading">
      <div id="loading-center">
         <div class="spinner-border text-primary" role="status"></div>
      </div>
   </div>
   <div class="wrapper">
      <div id="sidebar"></div>

      <!-- Page Content  -->
      <div id="content-page" class="content-page">
         <!-- TOP Nav Bar -->
         <div id="header"></div>
         <!-- TOP Nav Bar END -->
         <div class="container-fluid">

            <div class="iq-card">
               <div class="iq-card-header d-flex justify-content-between">
                  <div class="iq-header-title">
                     <h4 class="card-title">资料编辑</h4>
                  </div>
               </div>

               <div class="iq-card-body">
                  <div class="inputbox" style="width: 100%; max-width: 1000px; margin: 0 auto;">
                     <ul class="row">
                        <li class="col-md-9">
                           <ul class="row">
                              <li class="col-md-4">
                                 <h5 class="mt-2">昵称</h5>
                                 <fieldset class="form-group">
                                    <input type="text" class="form-control" placeholder="" value="时迁">
                                 </fieldset>
                              </li>
                              <li class="col-md-4">
                                 <h5 class="mt-2">性别</h5>
                                 <fieldset class="form-group">
                                    <select class="form-control" id="gender">
                                       <option value="男">男</option>
                                       <option value="女">女</option>
                                    </select>
                                 </fieldset>
                              </li>
                              <li class="col-md-4">
                                 <h5 class="mt-2">管理类型</h5>
                                 <fieldset class="form-group">
                                    <select class="form-control">
                                       <option value="student">学生管理</option>
                                       <option value="teacher">教师管理</option>
                                    </select>
                                 </fieldset>
                              </li>
                              <li class="col-md-6">
                                 <h5 class="mt-2">邮箱</h5>
                                 <fieldset class="form-group">
                                    <input type="text" class="form-control" value="admin@yahoo.com">
                                 </fieldset>
                              </li>
                              <li class="col-md-12">
                                 <h5 class="mt-2">所在机构</h5>
                                 <fieldset class="form-group">
                                    <select class="form-control">
                                       <option>珠海市第一中等职业学校（香华校区）</option>
                                    </select>
                                 </fieldset>
                              </li>

                           </ul>
                        </li>
                        <li class="col-md-3">
                           <div class="headedit text-center"><strong>头像</strong>
                              <div class="imgbox">
                                 <div class="touxiangbox">
                                    <img class="roundimg" src="images/user1.jpg" width="100">
                                    <div class="touxiangbox-bottom">更换头像</div>
                                 </div>
                              </div>
                              <a href="javascript:;" class="btn-upload-avatar upbtn btn-sm"><i
                                    class="ft-upload-cloud "></i>更换头像
                                 <input type="file" name="" id="">
                              </a>
                           </div>
                        </li>
                     </ul>
                  </div>
                  <div class="text-center mt-2">
                     <button class="btn btn-primary">保存修改</button>
                  </div>
               </div>

            </div>


         </div>
         <!-- Footer -->
         <footer class="bg-white iq-footer">
            <div class="container-fluid">
               <div class="row">
                  <div class="col-lg-6">
                     <ul class="list-inline mb-0">
                        <li class="list-inline-item"><a href="#">使用帮助</a></li>
                        <li class="list-inline-item"><a href="#">进入官网</a></li>
                     </ul>
                  </div>
                  <div class="col-lg-6 text-right">
                     Copyright 2024 <a href="">心理健康管理系统</a> 版权所有
                  </div>
               </div>
            </div>
         </footer>
         <!-- Footer END -->
      </div>
   </div>
   <!-- Wrapper END -->

   <script src="js/jquery.min.js"></script>
   <script src="js/bootstrap.min.js"></script>
   <script src="js/smooth-scrollbar.js"></script>
   <script src="js/custom.js"></script>
   <script src="js/edit_profile.js"></script>

   <link rel="stylesheet" href="laydate/theme/default/laydate.css">
   <script src="laydate/laydate.js"></script>
   <script>
      function showMessage(type, message) {
         const messageDiv = document.createElement('div');
         messageDiv.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					padding: 15px 20px;
					border-radius: 4px;
					color: white;
					z-index: 9999;
					opacity: 0;
					transition: opacity 0.3s ease-in-out;
				`;
         messageDiv.style.backgroundColor = type === 'error' ? '#ff4d4f' : '#52c41a';
         messageDiv.textContent = message;
         document.body.appendChild(messageDiv);

         setTimeout(() => messageDiv.style.opacity = '1', 100);
         setTimeout(() => {
            messageDiv.style.opacity = '0';
            setTimeout(() => document.body.removeChild(messageDiv), 300);
         }, 3000);
      }
      // 只保留一份检查token的函数
      function checkLoginStatus() {
         const token = localStorage.getItem('token');
         if (!token) {
            window.location.href = 'login.html';
            return false;
         }
         return true;
      }
      document.addEventListener('DOMContentLoaded', function () {
         checkLoginStatus();
      });

      // 新增倒计时跳转函数：显示文字倒计时，结束后清除token跳转登录
      function redirectToLoginWithCountdown(seconds) {
         let counter = seconds;
         showMessage('error', `服务器内部错误，${counter}秒后将跳转到登录页面`);
         const intervalId = setInterval(function () {
            counter--;
            if (counter > 0) {
               showMessage('error', `服务器内部错误，${counter}秒后将跳转到登录页面`);
            } else {
               clearInterval(intervalId);
               localStorage.removeItem('token');
               window.location.href = 'login.html';
            }
         }, 1000);
      }

      // 只保留一份全局ajax错误处理
      $(document).ajaxError(function (event, jqXHR) {
         if (jqXHR.status === 401 || jqXHR.status === 500) {
            redirectToLoginWithCountdown(3);
         }
      });

      // 加载用户数据，统一错误分支调用倒计时跳转
      window.onload = function () {
         localStorage.setItem('ip', 'http://10.11.126.174:809');
         const xhr = new XMLHttpRequest();
         const timeout = 10000; // 10秒超时
         let timeoutId;

         xhr.open('POST', localStorage.getItem('ip') + '/userLogin/pim', true);
         xhr.setRequestHeader('Authorization', localStorage.getItem('token'));
         xhr.setRequestHeader('Content-Type', 'application/json');

         xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
               clearTimeout(timeoutId);
               if (xhr.status === 200) {
                  try {
                     const response = JSON.parse(xhr.responseText);
                     if (response.code === 200) {
                        const userData = response.rows;
                        // 更新表单数据
                        document.querySelector('input[placeholder=""]').value = userData.name || '';
                        document.querySelector('#gender').value = userData.gender || '男';
                        document.querySelector('input[value="admin@yahoo.com"]').value = userData.branch || '';
                        // 更新头像
                        if (userData.img) {
                           document.querySelector('.roundimg').src = localStorage.getItem('ip') + userData.img;
                           console.log(localStorage.getItem('ip') + userData.img);
                        }
                     } else {
                        redirectToLoginWithCountdown(3);
                     }
                  } catch (error) {
                     showMessage('error', '解析响应数据失败');
                     console.error('解析响应数据失败:', error);
                  }
               } else {
                  redirectToLoginWithCountdown(3);
               }
            }
         };

         xhr.onerror = function () {
            clearTimeout(timeoutId);
            redirectToLoginWithCountdown(3);
         };

         // 设置请求超时
         timeoutId = setTimeout(() => {
            xhr.abort();
            redirectToLoginWithCountdown(3);
         }, timeout);

         xhr.send();
      };
   </script>
   <script type="module" src="js/main.js"></script>
</body>

</html>